<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Jadwal Sholat & Kiblat</title>
    <style>
        /* [Previous CSS styles remain exactly the same] */
    </style>
</head>
<body>
    <!-- [Previous HTML structure remains exactly the same] -->

    <script>
        // App state
        let currentPage = 'home';
        let currentLocation = null;
        let currentQiblaDirection = null;
        let watchId = null;
        let currentHeading = 0;
        
        // [Previous DOM elements and init() function remain the same until the compass functions]

        // Initialize compass
        function initCompass() {
            stopCompass();
            
            // Create compass markers
            compassMarkers.innerHTML = '';
            for (let i = 0; i < 360; i += 15) {
                const marker = document.createElement('div');
                marker.className = 'compass-marker';
                marker.style.transform = `rotate(${i}deg) translateY(-90px)`;
                
                // Add cardinal directions
                if (i % 90 === 0) {
                    const label = document.createElement('div');
                    label.className = 'compass-label';
                    label.style.transform = `rotate(${-i}deg) translateY(-70px)`;
                    
                    let direction;
                    if (i === 0) direction = 'N';
                    else if (i === 90) direction = 'E';
                    else if (i === 180) direction = 'S';
                    else if (i === 270) direction = 'W';
                    
                    label.textContent = direction;
                    label.classList.add('compass-north');
                    compassMarkers.appendChild(label);
                }
                
                compassMarkers.appendChild(marker);
            }
            
            // Request device orientation permission
            if (window.DeviceOrientationEvent) {
                if (typeof DeviceOrientationEvent.requestPermission === 'function') {
                    // iOS 13+ requires permission
                    DeviceOrientationEvent.requestPermission()
                        .then(response => {
                            if (response === 'granted') {
                                startCompass();
                            } else {
                                console.log('Device orientation permission denied');
                                showMessage('Izinkan akses orientasi perangkat untuk kompas yang akurat');
                            }
                        })
                        .catch(console.error);
                } else {
                    // Other browsers
                    startCompass();
                }
            } else {
                console.log('Device orientation not supported');
                showMessage('Browser tidak mendukung kompas. Gunakan perangkat lain.');
            }
        }
        
        // Start compass tracking
        function startCompass() {
            // Get current location first
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    position => {
                        currentLocation = {
                            latitude: position.coords.latitude,
                            longitude: position.coords.longitude
                        };
                        
                        // Calculate Qibla direction
                        calculateQiblaDirection();
                        
                        // Start watching device orientation
                        window.addEventListener('deviceorientation', handleOrientation, true);
                    },
                    error => {
                        console.error('Geolocation error:', error);
                        showMessage('Izinkan akses lokasi untuk arah kiblat yang akurat');
                    },
                    { enableHighAccuracy: true, timeout: 10000 }
                );
            } else {
                console.log('Geolocation not supported');
                showMessage('Browser tidak mendukung geolokasi');
            }
        }
        
        // Stop compass tracking
        function stopCompass() {
            window.removeEventListener('deviceorientation', handleOrientation, true);
        }
        
        // Calculate Qibla direction (angle from North to Ka'bah)
        function calculateQiblaDirection() {
            if (!currentLocation) return;
            
            // Ka'bah coordinates
            const kaabaLat = 21.422487;
            const kaabaLong = 39.826206;
            
            // Convert degrees to radians
            const phi1 = currentLocation.latitude * Math.PI / 180;
            const phi2 = kaabaLat * Math.PI / 180;
            const lambda1 = currentLocation.longitude * Math.PI / 180;
            const lambda2 = kaabaLong * Math.PI / 180;
            
            // Calculate Qibla direction using spherical trigonometry
            const y = Math.sin(lambda2 - lambda1);
            const x = Math.cos(phi1) * Math.tan(phi2) - Math.sin(phi1) * Math.cos(lambda2 - lambda1);
            let qiblaDirection = Math.atan2(y, x) * 180 / Math.PI;
            
            // Normalize to 0-360
            currentQiblaDirection = (qiblaDirection + 360) % 360;
            
            console.log(`Qibla direction calculated: ${currentQiblaDirection}°`);
            
            // Initial arrow position
            updateQiblaArrow(currentHeading);
        }
        
        // Handle device orientation changes
        function handleOrientation(event) {
            if (event.absolute && event.alpha !== null) {
                // alpha: rotation around z-axis (0-360)
                currentHeading = event.alpha;
                
                // iOS sometimes returns values > 360
                currentHeading = currentHeading % 360;
                
                // Update compass display
                updateQiblaArrow(currentHeading);
            }
        }
        
        // Update Qibla arrow position
        function updateQiblaArrow(heading) {
            if (currentQiblaDirection === null) return;
            
            // Calculate the angle between device heading and Qibla direction
            // The arrow should point to (qiblaDirection - heading)
            const angle = (currentQiblaDirection - heading + 360) % 360;
            
            // Rotate the arrow to point to Qibla direction
            qiblaArrow.style.transform = `rotate(${angle}deg) translateX(5px)`;
            
            // Update or create Qibla label
            let qiblaLabel = document.querySelector('.compass-qibla');
            if (!qiblaLabel) {
                qiblaLabel = document.createElement('div');
                qiblaLabel.className = 'compass-label compass-qibla';
                compassMarkers.appendChild(qiblaLabel);
            }
            
            // Position the label opposite to the arrow (180° difference)
            const labelAngle = (angle + 180) % 360;
            qiblaLabel.style.transform = `rotate(${-labelAngle}deg) translateY(-50px) rotate(${labelAngle}deg)`;
            qiblaLabel.textContent = `Kiblat ${Math.round(currentQiblaDirection)}°`;
            
            // Debug information
            console.log(`Device heading: ${Math.round(heading)}°, Qibla arrow: ${Math.round(angle)}°`);
        }

        // [Rest of the code remains the same]
    </script>
</body>
</html>
